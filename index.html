<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>YOLO Segmentation Demo</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #121212;
      color: #f5f5f5;
    }
    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    #preview-container {
      position: relative;
      display: inline-block;
      border: 1px solid #444;
      padding: 4px;
      background: #1e1e1e;
    }
    #preview {
      display: block;
      max-width: 800px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #result-json {
      width: 500px;
      height: 600px;
      background: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #444;
      padding: 10px;
      overflow: auto;
      font-size: 12px;
      white-space: pre;
    }
    .controls {
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
    }
    input[type="file"] {
      color: #f5f5f5;
    }
  </style>
</head>
<body>
  <h1>YOLO Segmentation FastAPI Demo</h1>

  <div class="controls">
    <label>Chọn ảnh:
      <input type="file" id="file-input" accept="image/*" />
    </label>
    <button id="btn-predict">Gửi lên API</button>
    <span id="status"></span>
  </div>

  <div class="container">
    <div id="preview-container">
      <img id="preview" alt="preview" />
      <canvas id="overlay"></canvas>
    </div>

    <pre id="result-json">{}</pre>
  </div>

  <script>
    const API_URL = "http://localhost:8000/predict"; // đúng với FastAPI bạn đang chạy

    const fileInput = document.getElementById("file-input");
    const btnPredict = document.getElementById("btn-predict");
    const statusSpan = document.getElementById("status");
    const previewImg = document.getElementById("preview");
    const overlayCanvas = document.getElementById("overlay");
    const resultJsonEl = document.getElementById("result-json");

    let selectedFile = null;

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      selectedFile = file;

      const reader = new FileReader();
      reader.onload = function (ev) {
        previewImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Khi ảnh load xong, resize canvas trùng kích thước ảnh
    previewImg.onload = function () {
      const w = previewImg.naturalWidth;
      const h = previewImg.naturalHeight;

      // đặt width/height hiển thị đúng kích thước gốc để toạ độ khớp
      previewImg.width = w;
      previewImg.height = h;

      overlayCanvas.width = w;
      overlayCanvas.height = h;

      // clear canvas
      const ctx = overlayCanvas.getContext("2d");
      ctx.clearRect(0, 0, w, h);
    };

    btnPredict.addEventListener("click", async () => {
      if (!selectedFile) {
        alert("Chọn ảnh trước đã.");
        return;
      }

      statusSpan.textContent = "Đang gửi...";
      resultJsonEl.textContent = "{}";

      const formData = new FormData();
      formData.append("file", selectedFile);

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const text = await res.text();
          statusSpan.textContent = "Lỗi: " + res.status;
          resultJsonEl.textContent = text;
          return;
        }

        const data = await res.json();
        statusSpan.textContent = "OK";
        resultJsonEl.textContent = JSON.stringify(data, null, 2);

        drawDetections(data);
      } catch (err) {
        console.error(err);
        statusSpan.textContent = "Lỗi gọi API";
      }
    });

    function drawDetections(data) {
      const ctx = overlayCanvas.getContext("2d");
      const w = overlayCanvas.width;
      const h = overlayCanvas.height;
      ctx.clearRect(0, 0, w, h);

      if (!data || !data.detections) return;

      // vẽ bbox & polygon
      data.detections.forEach((det) => {
        const { box, class_name, confidence, mask } = det;

        // Vẽ bounding box
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        const bw = box.x2 - box.x1;
        const bh = box.y2 - box.y1;
        ctx.strokeRect(box.x1, box.y1, bw, bh);

        // Vẽ label
        const label = `${class_name} ${(confidence * 100).toFixed(1)}%`;
        ctx.font = "14px sans-serif";
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        const tw = ctx.measureText(label).width;
        const th = 16;
        ctx.fillRect(box.x1, box.y1 - th, tw + 4, th);
        ctx.fillStyle = "white";
        ctx.fillText(label, box.x1 + 2, box.y1 - 3);

        // Vẽ mask polygon nếu có
        if (mask && Array.isArray(mask)) {
          ctx.beginPath();
          // mask là list segment, each segment.points = [[x,y], ...]
          mask.forEach((seg) => {
            const pts = seg.points;
            if (!pts || pts.length === 0) return;
            ctx.moveTo(pts[0][0], pts[0][1]);
            for (let i = 1; i < pts.length; i++) {
              ctx.lineTo(pts[i][0], pts[i][1]);
            }
            ctx.closePath();
          });
          ctx.globalAlpha = 0.25;
          ctx.fillStyle = "yellow";
          ctx.fill();
          ctx.globalAlpha = 1.0;
          ctx.strokeStyle = "yellow";
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      });
    }
  </script>
</body>
</html>
